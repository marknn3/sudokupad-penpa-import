<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8">
		<title>Sudokupad penpa+ importer 0.24.4</title>
		<meta name="author" content="Mark Langezaal, MarkTekfan#8907">
		<meta name="copyright"content="Mark Langezaal">
		<link rel="icon" type="image/x-icon" href="./favicon.ico">
		<script defer src="./puzzle-link-converter.js"></script>
		<script defer src="./fpuzzlesdecoder.js"></script>
		<script defer src="./penpa-style.js"></script>
		<script defer src="./penpa-puzzle.js"></script>
		<script defer src="./penpa-drawingcontext.js"></script>
		<script defer src="./penpa-tools.js"></script>
		<script defer src="./penpa-regions.js"></script>
		<script defer src="./penpa-decoder.js"></script>
		<script defer src="./penpa-symbol.js"></script>
		<script defer src="./penpa-general.js"></script>
		<script defer src="./puzzlink.js"></script>
		<script defer src="./portableevents.js"></script>
		<script defer src="./utilities.js"></script>
		<script defer src="./framework.js"></script>
		<script defer src="./puzzlezipper.js"></script>
		<script defer src="./lzipper.js"></script>
		<script defer src="./zlib.js"></script>
		<script defer src="./json-stringify-pretty-compact.js"></script>
		<link rel="stylesheet" href="./style.css">
	<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-KNP4FWPNGW"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-KNP4FWPNGW');
</script>
	</head>
	<body>

		<div class="app">

			<div class="topbar">
				<div class="menu">
					<button class="appmenu" id="appmenubtn"></button>
				</div>
				<img src="./images/SudokupadImport.png"> <span>&nbsp;&nbsp;&nbsp;</span>
				<span>SudokuPad Penpa+ Puzzle Importer v0.24.4</span>
			</div>
			<div class="penpa">
				<div>
					<div>
						<button style="margin-bottom:0.5rem;" id="btnloadfile" onclick="btnLoadFromFile()">Load from File</button>
						<div>
							<span class="extra">Penpa+,</span><span class="extra">f-puzzles,</span><span class="extra">SudokuPad</span> or <span class="extra">tinyurl.com</span> URL or JSON
						</div>
						<textarea rows="10" cols="120" id="penpa-url" placeholder="https://" oninput="textOnChange()"></textarea>
					</div>
					<div>
						<div class="div-select">
							<label>Open in</label>
							<select id="select-destination"></select>
						</div>			
						<div class="div-select">
							<label>Action</label>
							<select id="select-action" onchange="OnSelectActionChange(this.value)">
								<option value="open">Open in new tab</option>
								<option value="create-url">Create URL</option>
								<option value="create-tinyurl">Create short TinyPuz.com</option>
								<option disabled>──────────</option>
								<option value="convert-tojson">Convert to JSON</option>
							</select>
						</div>
						<button id="btnconvert" onclick="openInSudokupad()">Convert URL</button>
					</div>
					<div id="errorcontainer">
						<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 20 20"><title>alert</title><path fill="#ffad00" d="M19.64 16.36L11.53 2.3A1.85 1.85 0 0 0 10 1.21 1.85 1.85 0 0 0 8.48 2.3L.36 16.36C-.48 17.81.21 19 1.88 19h16.24c1.67 0 2.36-1.19 1.52-2.64zM11 16H9v-2h2zm0-4H9V6h2z"/></svg>
						<span id="errortext"></span>
					</div>
					<div id="generated-url-section">
						<div>Generated URL</div>
						<div>
							<textarea rows="6" cols="120" id="generated-url" placeholder="" readonly></textarea>
							<div id="copyToClipboard-a" class="clipboard icon"></div>
						</div>
						<button id="btncopyurl" onclick="copyUrl()" disabled>Copy URL to clipboard <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path fill="currentColor" d="M15 20H5V7c0-.55-.45-1-1-1s-1 .45-1 1v13c0 1.1.9 2 2 2h10c.55 0 1-.45 1-1s-.45-1-1-1zm5-4V4c0-1.1-.9-2-2-2H9c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h9c1.1 0 2-.9 2-2zm-2 0H9V4h9v12z"/></svg></button>
						<label id="urlIsCopied">URL is copied to clipboard</label>
					</div>
					<fieldset style="display: none;">
						<legend>Importer options</legend>
					</fieldset>
					<p>For any issues, questions or suggestions about this converter contact me:<br />
						<ul>
							<li><svg class="iconleft" width="24" height="24" viewBox="0 -29 256 256"><path fill="#5865F2" d="M217 17c-17-8-34-14-53-17l-7 14c-19-3-39-3-58 0L92 0C73 3 56 9 39 17 6 67-3 116 1 165c22 17 44 27 65 33l14-23-22-10 5-5c42 20 88 20 130 0l5 5-22 10 14 23c21-6 43-16 65-33 5-56-9-105-38-148ZM85 135c-12 0-23-12-23-26s11-26 23-26c13 0 24 12 23 26 1 14-10 26-23 26Zm86 0c-13 0-23-12-23-26s10-26 23-26c12 0 23 12 23 26s-11 26-23 26Z"/></svg>
								Discord: <a href="https://discordapp.com/users/MarkTekfan" target="_blank">MarkTekfan</a></li>
							<li>
								<svg class="iconleft" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" >
									<path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z" />
									<polyline points="22,6 12,13 2,6" />
								</svg>
								Email: <a href="mailto:MarkTekfan@gmail.com">MarkTekfan@gmail.com</a></li>
								<li> <img id="kofi-logo" style="position: absolute; margin-left: -8px; margin-top: -7px;" src="images/ko-fi-white.png" width="40"  />
									<span style="margin-left: 34px;">If this converter was useful for you, consider caffeinate me with some <a href="https://ko-fi.com/marktekfan" target="_blank">Ko-fi.com/MarkTekfan</a></span></li>
						</ul>
					</p>
					<div class="footer2">
						Created by <a href="https://discordapp.com/users/MarkTekfan#8907" target="_blank">Mark Langezaal</a> and <a href="https://svencodes.com" target="_blank">Sven Neumann</a> (&copy; 2023)
					</div>
					<div class="extra footer2">
						Support Sven on <a href="https://patreon.svencodes.com/" target="_blank">Patreon</a>!
					</div>
				</div>
			</div>
		</div>
		<script defer src="./test.js"></script>
		<script defer>
			function setError(errormessage) {
				document.getElementById('errortext').innerHTML = errormessage;
				let element = document.getElementById('errorcontainer')
				element.classList.remove('error');
				void element.offsetWidth; // trigger a DOM reflow to retrigger animation
				element.classList.add('error');
			}
			function clearError() {
				document.getElementById('errortext').innerHTML = '';
				document.getElementById('errorcontainer').classList.remove('error');
			}
			const urltext = document.getElementById('penpa-url');
			window.addEventListener('DOMContentLoaded', () => {
				const queryString = window.location.search;
				const urlParams = new URLSearchParams(queryString);
				const url = urlParams.get('url')
				const hash = window.location.hash;
				if (hash) {
					urltext.value = hash.substring(1);
					openInSudokupad(false);
				}
				else if (url) {
					urltext.value = decodeURIComponent(url);
				}
				urltext.focus();

				let settings = PenpaDecoder.settings;
				let fieldset = document.querySelector('fieldset');
				Object.keys(settings).forEach(setting => {
					// <div>
					// 	<input type="checkbox" id="thickLines" name="thickLines">
					// 	<label for="thickLines">Thicken lines to match Sudokupad feature lines</label>
					// </div>
					let divElem = document.createElement('div');
					let inputElem =  document.createElement('input');
					inputElem.type = 'checkbox';
					inputElem.id = setting;
					inputElem.name = setting;
					
					let labelElem =  document.createElement('label');
					labelElem.htmlFor = setting;
					labelElem.innerText = settings[setting].title;
					divElem.appendChild(inputElem);
					divElem.appendChild(labelElem);
					fieldset.appendChild(divElem);

					PenpaDecoder.flags[setting] = settings[setting].defaultValue;
				});

				const test = urlParams.get('test');
				if (test !== null) {
					fieldset.style.display = 'block';
				}

				PenpaDecoder.ParseUrlSettings();
				let options = document.querySelectorAll('fieldset input[type=checkbox]');
				for(let option of options) {
					option.checked = PenpaDecoder.flags[option.name] ? true : false;
				}

				//
				// DRAG-N-DROP
				//

				// https://developer.mozilla.org/en-US/docs/Web/API/HTML_Drag_and_Drop_API#drag_events
				let dropArea = document.querySelector('.penpa');
				['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
					dropArea.addEventListener(eventName, preventDefaults, false)
				});

				function preventDefaults(e) {
					e.preventDefault();
					e.stopPropagation();
				}

				['dragenter', 'dragover'].forEach(eventName => {
					dropArea.addEventListener(eventName, highlight, false)
				});

				['dragleave', 'drop'].forEach(eventName => {
					dropArea.addEventListener(eventName, unhighlight, false)
				});

				let dropdelaytimer = null;
				function highlight(e) {
					dropArea.classList.add('drophover')
					if (dropdelaytimer) clearTimeout(dropdelaytimer);
					dropdelaytimer = null;
				}

				function unhighlight(e) {
					dropdelaytimer = setTimeout(()=>{
						dropArea.classList.remove('drophover');
					}, 80);
				}

				dropArea.addEventListener('drop', handleDrop, false)

				function handleDrop(e) {
					clearError();
					const dt = e.dataTransfer;
					for (let type of dt.types) {
						// console.log({ type, data: dt.getData(type) });
						if (type === 'Files') {
							handleLoadFile(dt.files[0]);
							break;
						}
						else if (type.startsWith('text/')) {
							urltext.value = dt.getData(type);
							document.getElementById('generated-url').value = '';
							break;
						}
					}
				}

			});

			let lastActionSelection = 'open'; // default action

			const reUrl = /^(https?:\/\/)?(?:www\.)?[-a-zA-Z0-9@:%._\+~#=]{1,256}\.[a-zA-Z0-9()]{1,6}\b(?:[-a-zA-Z0-9()@:%_\+.~#?&\/=]*)$/;
			const reJSON = /^[\s'"]*\{/;
			function handleLoadFile(file) {
				if (file.size > 60000) {
					setError(`File '${file.name}' is too large`);
					return;
				}
				const reader = new FileReader();
				reader.onload = function(event) {
					let result = event.target.result;
					if (result.match(reUrl) || result.match(reJSON)) {
						urltext.value = result;
						document.getElementById('generated-url').value = '';
					}
					else {
						setError(`File '${file.name}' does not contain JSON or URL`);
					}
				};
				reader.readAsText(file);
			}

			function textOnChange(event) {
				clearError();
			}
			function OnSelectActionChange(value) {
				showUrl = value.startsWith('create');
				let section = document.getElementById('generated-url-section');
				section.classList.toggle('visible', showUrl);
				if (!value.includes('json')) {
					lastActionSelection = value;
				}
			}

			const destinations = [
				'https://sudokupad.app/',
				'https://beta.sudokupad.app/',
				'https://alpha.sudokupad.app/',
			]

			function addDestination(urlPrefix) {
				let selectElem = document.getElementById('select-destination');
				let option = document.createElement('option');
				option.value = urlPrefix;
				option.innerHTML = urlPrefix.match(/(?:https?:\/\/)?([^\/]+)/)[1]
				selectElem.appendChild(option);
			}
			destinations.forEach(url => addDestination(url));

			let selectElem = document.getElementById('select-destination');
			let destination = localStorage.destination;
			selectElem.value = destination;
			if (selectElem.value !== destination) {
				selectElem.selectedIndex = 0;
			}

			// Stub to capture messages
			const Swal = {
				fire: function(opts) {
					setError(opts.html);
				}
			}

			const reFPuzPrefix = /^(fpuz(?:zles)?)(.*)/;
			const stripFPuzPrefix = fpuzzle => fpuzzle.replace(reFPuzPrefix, '$2');

			function openInSudokupad(openinNewWindow = true)
			{
				let selectElem = document.getElementById('select-destination');
				let destination = selectElem.value;
				localStorage.destination = destination;

				let urltext = document.getElementById('penpa-url')
				let urlstring = urltext.value.trim();

				let param = urlstring.substring(urlstring.indexOf('&') + 1);
				if (param.length === 0)
					return;

				let button = document.getElementById('btnconvert');
				button.disabled = true;
				button.innerHTML = "Converting...";

				Promise.resolve(urlstring)
				.then(url => puzzleLinkConverter.expandShortUrl(url))
				.then(url => puzzleLinkConverter.convertPuzzleUrl(url))
				.then(async puzzleid => {
					if (!puzzleid) {
						throw {customMessage: 'Not a recognized puzzle URL'}
					} 
					if (destination.includes('?')) {
						puzzleid = puzzleid.replace('?', '&');
					}
					let redirect = destination + puzzleid;
					console.log(redirect, redirect.length);

					if (!openinNewWindow) {
						window.open(redirect, '_self');
					}
					else {
						let generatedUrlElem = document.getElementById('generated-url');
						let actionElem = document.getElementById('select-action');
						switch(actionElem.value)
						{
							case 'create-url':
								generatedUrlElem.value = redirect;
								generatedUrlElem.select();
								generatedUrlElem.focus();
								var btncopyurl = document.getElementById('btncopyurl');
								btncopyurl.disabled = !redirect;				
								break;

							case 'create-tinyurl':
								generatedUrlElem.value = '';
								generatedUrlElem.placeholder = '...Creating TinyPuz URL...';
								let newUrl = await request_shortlink(redirect);
								generatedUrlElem.value = newUrl || 'Error while creating TinyPuz URL';
								if (newUrl) {
									generatedUrlElem.select();
									generatedUrlElem.focus();
								}
								var btncopyurl = document.getElementById('btncopyurl');
								btncopyurl.disabled = !newUrl;								
								break;								

							case 'convert-tojson':
								const {stringify} = JsonStringifyPrettyCompact;
								const stringifyPretty = (obj) => stringify(obj, {maxLength: 150});
								generatedUrlElem.value = '';
								let raw = puzzleid.split('&')[0];
								if (reFPuzPrefix.test(puzzleid)) {
									raw = stripFPuzPrefix(raw);
									let fpuzzle = loadFPuzzle.saveDecodeURIComponent(raw);
									if(typeof fpuzzle === 'string') {
										try {
											fpuzzle = JSON.parse(loadFPuzzle.decompressPuzzle(fpuzzle));
										}
										catch {
											// maybe it was zipped, but this is unlikely
											fpuzzle = JSON.parse(PuzzleZipper.unzip(loadFPuzzle.decompressPuzzle(fpuzzle)));
										}
									}
									urltext.value = stringifyPretty(fpuzzle);
									document.getElementById('generated-url').value = '';
								}
								else if (puzzleid.startsWith('ctc') || puzzleid.startsWith('scl')) {
									raw = raw.replace(/^(ctc|scl)/, '');
									let json = JSON.parse(PuzzleZipper.unzip(loadFPuzzle.decompressPuzzle(raw)));
									urltext.value = stringifyPretty(json);
									document.getElementById('generated-url').value = '';
								}
								else {
									setError('Not a recognized JSON puzzle format');
									break;
								}
								if (lastActionSelection) {
									actionElem.value = lastActionSelection;
									OnSelectActionChange(lastActionSelection);
								}
								break;								

							default:
								window.open(redirect, '_blank');
								return;
						}
					}
				})
				.catch(err => {
					console.error('Unable to convert Penpa puzzle link');
					console.log(err);
					setError(err.customMessage || 'An error occured while processing the URL.<br>');
				})
				.then(()=> {
					button.disabled = false;
					button.innerHTML = "Convert URL";
				});
			}

			// const _handleLoadFromFile = async function(file) {
			// 	try {
			// 		let payload = (await readFile(file)).target.result;
			// 		await this.loadPayload(payload);
			// 	}
			// 	catch (err) {
			// 		console.error('Error in handleLoadFromFile:', err);
			// 		//this.handleDialogCancel();
			// 		setError('Error loading data from file. Possibly invalid or corrupted.');
			// 	}
			// 	//this.handleDialogCancel();
			// };

			const loadFromFile = (handleFile, opts) => {
				let btn = Object.assign(document.createElement('input'), {type: 'file', visibility: 'hidden'}, opts);
				let handleChange = event => {
					btn.removeEventListener('change', handleChange);
					handleFile(((event.target || {}).files || [])[0]);
				};
				btn.addEventListener('change', handleChange);
				btn.click();
				return btn;
			};

			function btnLoadFromFile() {
				console.log('load from file!');
				loadFromFile(handleLoadFile, {accept: '.json, .txt'});
			}

			function copyUrl() {
				let textarea = document.getElementById('generated-url');
				navigator.clipboard.writeText(textarea.value);
				let element = document.getElementById('urlIsCopied');
				// Retrigger animation
				element.classList.remove("animation");
				void element.offsetWidth; // trigger a DOM reflow
				element.classList.add("animation");
			}

			async function request_shortlink(url) {
				try {
					let res = await fetch('https://tinyurl.com/api-create.php?url=' + url);
					let text = await res.text() || '';
					return text.replace('tinyurl.com', 'tinypuz.com');
				} catch (error) {
					console.log('Error while creating TinyPuz URL');
					return null;
				}
			}
		</script>

	</body>
</html>
